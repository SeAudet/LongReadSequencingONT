#!/bin/bash
#SBATCH -N 1 #Number of nodes
#SBATCH --cpus-per-task={0}
#SBATCH --mem {1}G # memory pool for all cores
#SBATCH -t {2} # time (DD-HH:MM)
#SBATCH -o {3}.%N.%j.log
#SBATCH -e {3}.%N.%j.log
#SBATCH --mail-type=FAIL
#SBATCH --account=rrg-tetreaum
#SBATCH --mail-user={4}
#
module load nextflow
module load apptainer
#
export NXF_SINGULARITY_CACHEDIR="/lustre09/project/6019267/shared/tools/main_pipelines/long-read/epi2me_cache/"
#
NAME={5}
BASEDIR={6}
WORKDIR="${BASEDIR}/work"
EXARGS={7}
BAM="${BASEDIR}/alignments/${NAME}_sorted.bam"
REF={8}
BASECALLER={9}
OUT="${BASEDIR}/results/${NAME}"
APPTAINER_CONFIG="/lustre09/project/6019267/shared/tools/main_pipelines/long-read/apptainer_nextflow.config"

mkdir -p ${OUT}

nextflow run epi2me-labs/wf-human-variation \
    $EXARGS \
    --bam_min_coverage 0 \
    --override_basecaller_cfg $BASECALLER \
    -w $WORKDIR \
    --bam $BAM \
    --ref $REF \
    --sample_name $NAME \
    --out_dir $OUT \
    --threads {0} \
    --ubam_map_threads {0} \
    --ubam_sort_threads {0} \
    --ubam_bam2fq_threads {0} \
    --modkit_threads {0} \
    -c $APPTAINER_CONFIG \
    -profile apptainer